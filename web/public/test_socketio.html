<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Connection Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        h1 { color: #00ff00; text-align: center; }
        .status {
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #00ff00;
            background: #0a0a0a;
        }
        .status.connected {
            border-color: #00ff00;
            color: #00ff00;
        }
        .status.disconnected {
            border-color: #ff0000;
            color: #ff0000;
        }
        .log {
            background: #000;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #00ff00;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        input {
            width: 100%;
            padding: 10px;
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        .info { color: #00aaff; }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
    </style>
</head>
<body>
<h1>üîå Socket.IO Connection Test</h1>

<div>
    <label for="serverUrl">Socket.IO Server URL:</label>
    <input type="text" id="serverUrl" value="http://127.0.0.1:9999" placeholder="http://your-server:9999">
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <button onclick="testJoinGame()">Test Join Game</button>
    <button onclick="clearLog()">Clear Log</button>
</div>

<div class="status disconnected" id="status">
    ‚ùå Not Connected
</div>

<div class="log" id="log">
    Ready to test Socket.IO connection...

    Instructions:
    1. Make sure your Python server is running (python socketio_server.py)
    2. Enter the correct Socket.IO server URL above
    3. Click "Connect"
    4. Check the logs below for connection status
</div>

<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script>
    let socket = null;

    function log(message, type = 'info') {
        const logEl = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const className = type;
        logEl.innerHTML += `\n<span class="${className}">[${timestamp}] ${message}</span>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStatus(connected) {
        const statusEl = document.getElementById('status');
        if (connected) {
            statusEl.className = 'status connected';
            statusEl.textContent = '‚úÖ Connected';
        } else {
            statusEl.className = 'status disconnected';
            statusEl.textContent = '‚ùå Disconnected';
        }
    }

    function connect() {
        const serverUrl = document.getElementById('serverUrl').value;

        if (socket && socket.connected) {
            log('Already connected!', 'info');
            return;
        }

        log(`Attempting to connect to: ${serverUrl}`, 'info');

        try {
            socket = io(serverUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000
            });

            // Connection events
            socket.on('connect', () => {
                log('‚úÖ Successfully connected to Socket.IO server!', 'success');
                log(`Socket ID: ${socket.id}`, 'success');
                updateStatus(true);
            });

            socket.on('disconnect', (reason) => {
                log(`‚ùå Disconnected: ${reason}`, 'error');
                updateStatus(false);
            });

            socket.on('connect_error', (error) => {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                log('Make sure the Python server is running and the URL is correct', 'error');
                updateStatus(false);
            });

            // Test event listeners
            socket.on('connection_established', (data) => {
                log(`üì® Received: connection_established`, 'success');
                log(JSON.stringify(data, null, 2), 'info');
            });

            socket.on('join_result', (data) => {
                log(`üì® Received: join_result`, 'success');
                log(JSON.stringify(data, null, 2), 'info');
            });

            socket.on('game_state_update', (data) => {
                log(`üì® Received: game_state_update`, 'success');
                log(JSON.stringify(data, null, 2), 'info');
            });

            socket.on('error', (data) => {
                log(`‚ùå Server error: ${data.message}`, 'error');
            });

        } catch (error) {
            log(`‚ùå Failed to create socket: ${error.message}`, 'error');
        }
    }

    function disconnect() {
        if (!socket) {
            log('Not connected', 'info');
            return;
        }

        socket.disconnect();
        socket = null;
        log('Disconnected from server', 'info');
        updateStatus(false);
    }

    function testJoinGame() {
        if (!socket || !socket.connected) {
            log('‚ùå Not connected! Click "Connect" first', 'error');
            return;
        }

        const testGameId = 'test_' + Date.now();
        const testPlayerId = 'p_test_' + Math.random().toString(36).substr(2, 9);
        const testPlayerName = 'TestPlayer';

        log(`üì§ Sending join_game request...`, 'info');
        log(`Game ID: ${testGameId}`, 'info');
        log(`Player ID: ${testPlayerId}`, 'info');
        log(`Player Name: ${testPlayerName}`, 'info');

        socket.emit('join_game', {
            game_id: testGameId,
            player_id: testPlayerId,
            player_name: testPlayerName,
            player_count: 4
        });

        log('‚è≥ Waiting for response...', 'info');
    }

    function clearLog() {
        document.getElementById('log').innerHTML = 'Log cleared.\n';
    }

    // Auto-detect server URL from query params
    const urlParams = new URLSearchParams(window.location.search);
    const serverParam = urlParams.get('server');
    if (serverParam) {
        document.getElementById('serverUrl').value = serverParam;
    }
</script>

<div style="margin-top: 30px; padding: 15px; border: 1px solid #555; background: #0a0a0a;">
    <h3 style="margin-top: 0;">Troubleshooting</h3>
    <ul style="color: #aaa; font-size: 14px;">
        <li><strong>Connection timeout:</strong> Check if Python server is running</li>
        <li><strong>Connection refused:</strong> Check if port 9999 is open in firewall</li>
        <li><strong>CORS errors:</strong> Socket.IO server allows all origins by default</li>
        <li><strong>Mixed content:</strong> If your site uses HTTPS, Socket.IO URL must also use HTTPS</li>
        <li><strong>WebSocket not supported:</strong> Socket.IO will automatically fall back to polling</li>
    </ul>

    <h3>Quick Tests:</h3>
    <code style="display: block; background: #000; padding: 10px; color: #00ff00; margin: 5px 0;">
        # Check if server is running:<br>
        netstat -an | grep 9999<br>
        <br>
        # Test with curl (should get Socket.IO response):<br>
        curl http://localhost:9999/socket.io/<br>
    </code>
</div>
</body>
</html>